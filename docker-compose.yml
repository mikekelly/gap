# Docker Compose configuration for GAP testing and development
# This sets up a complete test environment with GAP server and optional test services
#
# Usage:
#   Local build:      docker compose up gap-server
#   Docker Hub image: docker compose up gap-server-hub
#   Run tests:        docker compose --profile test up
#
# Important: The proxy uses HTTPS on port 9443. Agents must trust GAP's CA certificate.
# Export CA: docker cp gap-server:/var/lib/gap/ca.crt ./gap-ca.crt

services:
  # GAP server (local build from Dockerfile)
  gap-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: gap-server
    ports:
      - "9443:9443"
      - "9080:9080"
    volumes:
      - gap-data:/var/lib/gap
    environment:
      - RUST_LOG=gap_server=info,gap_lib=info
      - GAP_ENCRYPTION_KEY=${GAP_ENCRYPTION_KEY}
    restart: unless-stopped
    networks:
      - gap-network

  # GAP server (from Docker Hub)
  gap-server-hub:
    image: mikekelly321/gap:latest
    container_name: gap-server-hub
    ports:
      - "9443:9443"
      - "9080:9080"
    volumes:
      - gap-data:/var/lib/gap
    environment:
      - RUST_LOG=gap_server=info,gap_lib=info
    restart: unless-stopped
    networks:
      - gap-network
    profiles:
      - hub

  # Integration test runner
  # Runs comprehensive integration tests against the GAP server
  # Usage: docker compose up test-runner --build
  test-runner:
    build:
      context: .
      dockerfile: Dockerfile.test-runner
    container_name: gap-test-runner
    depends_on:
      gap-server:
        condition: service_healthy
      mock-api:
        condition: service_started
    volumes:
      - ./smoke-tests/test-docker-integration.sh:/tests/test-docker-integration.sh:ro
      - gap-data:/var/lib/gap:ro
    environment:
      - GAP_SERVER_URL=https://gap-server:9080
    networks:
      - gap-network
    profiles:
      - test

  # Mock upstream API for testing
  # Provides a simple echo/mirror service to test proxy behavior
  mock-api:
    image: mccutchen/go-httpbin
    container_name: gap-mock-api
    ports:
      - "8080:8080"
    networks:
      - gap-network
    restart: unless-stopped

  # Example: Agent using HTTPS proxy
  # Uncomment and customize for your agent
  # example-agent:
  #   image: your-agent-image
  #   environment:
  #     # Proxy is HTTPS, not HTTP
  #     - HTTPS_PROXY=https://gap-server:9443
  #     # Agent must trust GAP's CA for proxy TLS and MITM
  #     - NODE_EXTRA_CA_CERTS=/certs/ca.crt
  #     - GAP_TOKEN=${GAP_TOKEN}
  #   volumes:
  #     # Mount CA cert exported from gap-server container
  #     - ./gap-ca.crt:/certs/ca.crt:ro
  #   networks:
  #     - gap-network
  #   depends_on:
  #     gap-server:
  #       condition: service_healthy

volumes:
  # Persistent storage for GAP data
  # Contains: secrets, plugins, tokens, CA key
  gap-data:
    driver: local

networks:
  # Isolated network for GAP services
  gap-network:
    driver: bridge
