# Docker Compose configuration for ACP testing and development
# This sets up a complete test environment with ACP server and optional test services
#
# Usage:
#   Local build:      docker compose up acp-server
#   Docker Hub image: docker compose up acp-server-hub
#   Run tests:        docker compose --profile test up

services:
  # ACP server (local build from Dockerfile)
  acp-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: acp-server
    ports:
      - "9443:9443"
      - "9080:9080"
    volumes:
      - acp-data:/var/lib/acp
    environment:
      - RUST_LOG=acp_server=info,acp_lib=info
    restart: unless-stopped
    networks:
      - acp-network

  # ACP server (from Docker Hub)
  acp-server-hub:
    image: mikekelly/acp:latest
    container_name: acp-server-hub
    ports:
      - "9443:9443"
      - "9080:9080"
    volumes:
      - acp-data:/var/lib/acp
    environment:
      - RUST_LOG=acp_server=info,acp_lib=info
    restart: unless-stopped
    networks:
      - acp-network
    profiles:
      - hub

  # Integration test runner
  # Runs comprehensive integration tests against the ACP server
  # Usage: docker compose up test-runner --build
  test-runner:
    build:
      context: .
      dockerfile: Dockerfile.test-runner
    container_name: acp-test-runner
    depends_on:
      acp-server:
        condition: service_healthy
      mock-api:
        condition: service_started
    volumes:
      - ./smoke-tests/test-docker-integration.sh:/tests/test-docker-integration.sh:ro
    environment:
      - ACP_SERVER_URL=http://acp-server:9080
    networks:
      - acp-network
    profiles:
      - test

  # Mock upstream API for testing
  # Provides a simple echo/mirror service to test proxy behavior
  mock-api:
    image: mccutchen/go-httpbin
    container_name: acp-mock-api
    ports:
      - "8080:8080"
    networks:
      - acp-network
    restart: unless-stopped

volumes:
  # Persistent storage for ACP data
  # Contains: secrets, plugins, tokens, CA key
  acp-data:
    driver: local

networks:
  # Isolated network for ACP services
  acp-network:
    driver: bridge
